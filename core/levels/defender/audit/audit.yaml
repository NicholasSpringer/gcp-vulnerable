imports:
- path: bucket_acl.jinja
- path: sql_db.jinja
- path: cloud_function.jinja
- path: iam_policy.jinja
- path: service_account.jinja

resources:
- name: vm-image-bucket
  type: bucket_acl.jinja
  properties:
    nonce: {{ nonce }}
    acl_entries:
      - service_account_id: dev-account
        role: OWNER
- name: log-viewer
  type: service_account.jinja
- name: dev-account
  type: service_account.jinja
- name: userdata-db
  type: sql_db.jinja
  properties:
    region: us-west1
    root_password: {{ root_password }}
    nonce: {{ nonce }}

- name: api-engine
  type: container_vm.jinja
  properties:
    zone: us-west1-b
    open_external: true
    open_http: true
    container_manifest: |
      apiVersion: v1
      kind: Pod
      metadata:
        name: a6
      spec:
        containers:
          - name: a6
            image: docker.io/aujxn/defender-audit:latest
            imagePullPolicy: Always
            ports:
              - containerPort: 80
                hostPort: 80

- name: compute-admin
  type: service_account.jinja

- name: iam_policy
  type: iam_policy.jinja
  properties:
    bindings:
    - service_account_id: api-engine-sa
      role:
        name: roles/iam.serviceAccountAdmin
    - service_account_id: api-engine-sa
      role:
        name: roles/cloudsql.admin
    - service_account_id: api-engine-sa
      role:
        name: roles/logging.logWriter

    - service_account_id: compute-admin
      role:
        name: roles/compute.admin
    - service_account_id: compute-admin
      role:
        name: roles/iam.serviceAccountUser
    - service_account_id: log-viewer
      role:
        name: roles/logging.viewer
    - service_account_id: log-viewer
      role:
        name: roles/logging.configWriter
    - service_account_id: dev-account
      role:
        name: roles/iam.serviceAccountUser