imports:
- path: sql_db.jinja
- path: cloud_function.jinja
- path: iam_policy.jinja

resources:
- name: userdata-db
  type: sql_db.jinja
  properties:
    region: us-west1
    root_password: {{ root_password }}
    nonce: {{ nonce }}

- name: api-engine
  type: container_vm.jinja
  properties:
    zone: us-west1-b
    open_external: true
    open_http: true
    container_manifest: |
      apiVersion: v1
      kind: Pod
      metadata:
        name: a6
      spec:
        containers:
          - name: a6
            image: docker.io/aujxn/defender-audit:latest
            imagePullPolicy: Always
            ports:
              - containerPort: 80
                hostPort: 80

- name: iam_policy
  type: iam_policy.jinja
  properties:
    bindings:
    - service_account_id: api-engine-sa
      role:
        name: roles/iam.serviceAccountAdmin
    - service_account_id: api-engine-sa
      role:
        name: roles/cloudsql.admin